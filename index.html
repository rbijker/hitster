<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="HITSTER">
<meta name="theme-color" content="#08080d">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:opsz@9..40;wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<title>HITSTER</title>
<style>
:root {
  --bg: #08080d;
  --s1: #111118;
  --s2: #1a1a24;
  --s3: #22222f;
  --brd: #2a2a3a;
  --acc: #ff3d5a;
  --acc-g: rgba(255,61,90,.25);
  --gold: #ffd700;
  --grn: #34d399;
  --blu: #60a5fa;
  --txt: #eaeaf2;
  --dim: #6b6b82;
  --safe-t: env(safe-area-inset-top);
  --safe-b: env(safe-area-inset-bottom);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{height:100%;overflow:hidden;}
body{
  font-family:'DM Sans',system-ui,sans-serif;
  background:var(--bg);color:var(--txt);
  height:100%;overflow:hidden;
  overscroll-behavior:none;
  -webkit-user-select:none;user-select:none;
}
/* iOS safe areas */
.safe-top{padding-top:max(12px,var(--safe-t));}
.safe-bottom{padding-bottom:max(16px,var(--safe-b));}

.app{
  height:100%;display:flex;flex-direction:column;
  max-width:480px;margin:0 auto;
}

/* ‚îÄ‚îÄ‚îÄ Screens ‚îÄ‚îÄ‚îÄ */
.scr{display:none;flex-direction:column;height:100%;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;}
.scr.on{display:flex;}
.scr-body{flex:1;padding:0 20px;overflow-y:auto;-webkit-overflow-scrolling:touch;}
.scr-foot{padding:12px 20px;padding-bottom:max(16px,var(--safe-b));}

@keyframes up{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes pop{from{transform:scale(.88);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes glow{0%,100%{box-shadow:0 0 8px var(--acc-g)}50%{box-shadow:0 0 24px var(--acc-g)}}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}

/* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
.hdr{text-align:center;padding:16px 0 12px;}
.hdr h1{
  font-family:'Bebas Neue',sans-serif;font-size:2.6rem;letter-spacing:10px;line-height:1;
  background:linear-gradient(135deg,var(--acc),#ff8a65,var(--gold));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.hdr .sub{font-family:'JetBrains Mono',monospace;font-size:.6rem;color:var(--dim);letter-spacing:3px;text-transform:uppercase;margin-top:4px;}

/* ‚îÄ‚îÄ‚îÄ Card / Section ‚îÄ‚îÄ‚îÄ */
.card{
  background:var(--s1);border:1px solid var(--brd);border-radius:16px;
  padding:18px;margin-bottom:12px;animation:up .35s ease both;
}
.card h2{font-family:'Bebas Neue',sans-serif;font-size:1.25rem;letter-spacing:2px;color:var(--acc);margin-bottom:10px;}

/* ‚îÄ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ‚îÄ */
.btn{
  border:none;border-radius:14px;cursor:pointer;transition:all .15s;
  font-family:'DM Sans',sans-serif;font-weight:700;font-size:.88rem;
  padding:14px 24px;width:100%;text-align:center;
  -webkit-tap-highlight-color:transparent;
  active-opacity:.8;
}
.btn:active{transform:scale(.97);opacity:.85;}
.btn-main{background:var(--acc);color:#fff;font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:3px;}
.btn-main:disabled{opacity:.3;}
.btn-s{background:var(--s2);color:var(--txt);border:1px solid var(--brd);padding:12px 18px;border-radius:12px;width:auto;}
.btn-s.on{border-color:var(--acc);background:rgba(255,61,90,.1);}
.btn-grn{background:var(--grn);color:var(--bg);}
.btn-gold{background:var(--gold);color:var(--bg);}
.btn-ghost{background:transparent;color:var(--dim);border:1px dashed var(--brd);border-radius:12px;padding:12px;}

/* ‚îÄ‚îÄ‚îÄ Mode Cards ‚îÄ‚îÄ‚îÄ */
.modes{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.mcard{
  background:var(--s2);border:2px solid var(--brd);border-radius:14px;
  padding:14px;cursor:pointer;transition:all .2s;position:relative;
}
.mcard:active{transform:scale(.97);}
.mcard.sel{border-color:var(--acc);background:rgba(255,61,90,.06);}
.mcard .mi{font-size:1.4rem;margin-bottom:4px;}
.mcard .mt{font-family:'Bebas Neue',sans-serif;font-size:1.05rem;letter-spacing:1.5px;}
.mcard .md{font-size:.68rem;color:var(--dim);margin-top:3px;line-height:1.3;}
.mcard .mk{font-family:'JetBrains Mono',monospace;font-size:.6rem;color:var(--gold);margin-top:6px;}

/* ‚îÄ‚îÄ‚îÄ Chips ‚îÄ‚îÄ‚îÄ */
.chips{display:flex;flex-wrap:wrap;gap:6px;}
.chip{
  background:var(--s2);border:1px solid var(--brd);border-radius:10px;
  padding:8px 14px;cursor:pointer;transition:all .15s;
  display:flex;align-items:center;gap:6px;font-size:.82rem;font-weight:600;
}
.chip:active{transform:scale(.95);}
.chip.sel{border-color:var(--acc);background:rgba(255,61,90,.1);}
.chip .ce{font-size:1rem;}

/* ‚îÄ‚îÄ‚îÄ Player rows ‚îÄ‚îÄ‚îÄ */
.prow{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.pdot{width:28px;height:28px;border-radius:50%;flex-shrink:0;}
.pinp{
  flex:1;background:var(--s2);border:1px solid var(--brd);border-radius:10px;
  padding:11px 14px;color:var(--txt);font-family:'DM Sans',sans-serif;font-size:.88rem;outline:none;
}
.pinp:focus{border-color:var(--acc);}
.prm{background:none;border:none;color:var(--dim);font-size:1rem;padding:4px 8px;cursor:pointer;}

/* ‚îÄ‚îÄ‚îÄ GAME TOP BAR ‚îÄ‚îÄ‚îÄ */
.gtop{display:flex;justify-content:space-between;align-items:center;padding:8px 20px;border-bottom:1px solid var(--brd);}
.gtop .gl{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--dim);}
.gtop .gbadge{font-family:'JetBrains Mono',monospace;font-size:.58rem;padding:3px 8px;border-radius:5px;background:var(--s2);border:1px solid var(--brd);color:var(--gold);letter-spacing:1px;}
.gtop .gp{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:1.5px;display:flex;align-items:center;gap:6px;}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;}

/* ‚îÄ‚îÄ‚îÄ Scores ‚îÄ‚îÄ‚îÄ */
.scores{display:flex;gap:6px;padding:10px 20px;overflow-x:auto;-webkit-overflow-scrolling:touch;}
.spill{
  background:var(--s1);border:1px solid var(--brd);border-radius:12px;
  padding:8px 14px;display:flex;align-items:center;gap:8px;flex-shrink:0;
  transition:all .2s;min-width:100px;
}
.spill.on{border-color:var(--acc);box-shadow:0 0 10px var(--acc-g);}
.spill .sn{font-weight:700;font-size:.78rem;}
.spill .sc{font-family:'JetBrains Mono',monospace;font-weight:700;margin-left:auto;font-size:.82rem;}
.spill .st{display:flex;gap:1px;margin-left:4px;}
.tok{width:12px;height:12px;background:var(--gold);border-radius:50%;border:1px solid rgba(0,0,0,.2);}
.tok.empty{background:var(--s3);border-color:var(--brd);}

/* Coop status */
.coop-bar{
  display:flex;justify-content:space-between;padding:10px 20px;
  background:var(--s1);border-bottom:1px solid var(--brd);
}
.coop-bar .cl{font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--dim);}
.coop-bar .cv{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;}

/* ‚îÄ‚îÄ‚îÄ Vinyl ‚îÄ‚îÄ‚îÄ */
.vcard{
  background:var(--s1);border:1px solid var(--brd);border-radius:20px;
  padding:24px 20px;text-align:center;margin:12px 20px;position:relative;overflow:hidden;
}
.vcard::before{
  content:'';position:absolute;top:-40%;left:-40%;width:180%;height:180%;
  background:radial-gradient(circle at 30% 30%,rgba(255,61,90,.03),transparent 50%);pointer-events:none;
}
.vdisc{
  width:120px;height:120px;border-radius:50%;
  background:conic-gradient(from 0deg,#111,#1e1e1e,#111,#191919,#111,#1e1e1e,#111);
  margin:0 auto 16px;position:relative;box-shadow:0 0 24px rgba(0,0,0,.5);
}
.vdisc.spin{animation:spin 2s linear infinite;}
.vdisc::after{
  content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:30px;height:30px;border-radius:50%;background:var(--acc);
  box-shadow:0 0 12px var(--acc-g);
}
.vdisc .gr{
  position:absolute;inset:12px;border-radius:50%;
  border:1px solid rgba(255,255,255,.025);
  box-shadow:inset 0 0 0 6px rgba(255,255,255,.015),inset 0 0 0 12px rgba(255,255,255,.02),
  inset 0 0 0 18px rgba(255,255,255,.015),inset 0 0 0 24px rgba(255,255,255,.02);
}
.vstat{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--dim);letter-spacing:2px;text-transform:uppercase;margin-bottom:6px;}

/* Play + Spotify buttons */
.play-row{display:flex;gap:10px;justify-content:center;align-items:center;}
.pbtn{
  width:56px;height:56px;border-radius:50%;background:var(--acc);border:none;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  box-shadow:0 4px 16px var(--acc-g);transition:all .15s;
}
.pbtn:active{transform:scale(.92);}
.pbtn svg{width:22px;height:22px;fill:#fff;margin-left:2px;}
.sp-btn{
  height:44px;padding:0 16px;border-radius:22px;
  background:#1DB954;border:none;color:#fff;
  font-family:'DM Sans',sans-serif;font-weight:700;font-size:.78rem;
  cursor:pointer;display:flex;align-items:center;gap:6px;
  transition:all .15s;
}
.sp-btn:active{transform:scale(.94);}
.sp-btn svg{width:18px;height:18px;fill:#fff;}

/* Revealed info */
.rinfo{margin-top:14px;}
.rinfo .rt{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:1.5px;}
.rinfo .ra{font-size:.85rem;color:var(--dim);}
.rinfo .ry{font-family:'JetBrains Mono',monospace;font-size:1.8rem;font-weight:700;color:var(--gold);margin-top:4px;}

/* ‚îÄ‚îÄ‚îÄ Timeline ‚îÄ‚îÄ‚îÄ */
.tlabel{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;color:var(--dim);padding:0 20px;margin-bottom:6px;}
.tlwrap{overflow-x:auto;padding:8px 20px 12px;-webkit-overflow-scrolling:touch;}
.tl{display:flex;align-items:center;gap:5px;min-height:70px;}
.tlc{
  background:var(--s2);border:1px solid var(--brd);border-radius:10px;
  padding:7px 10px;min-width:88px;text-align:center;flex-shrink:0;
}
.tlc .ty{font-family:'JetBrains Mono',monospace;font-size:.9rem;font-weight:700;color:var(--gold);}
.tlc .tn{font-size:.6rem;color:var(--dim);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:80px;}
.tls{
  width:36px;height:56px;border:2px dashed var(--brd);border-radius:10px;
  display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;
  transition:all .15s;color:var(--dim);font-size:1rem;
}
.tls:active{transform:scale(.92);}
.tls.sel{border-color:var(--grn);background:rgba(52,211,153,.08);color:var(--grn);box-shadow:0 0 10px rgba(52,211,153,.15);}

/* ‚îÄ‚îÄ‚îÄ Action panels ‚îÄ‚îÄ‚îÄ */
.apanel{padding:0 20px;margin-bottom:10px;animation:up .25s ease both;}
.abar{background:var(--s1);border:1px solid var(--brd);border-radius:14px;padding:16px;}
.abar .at{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;color:var(--dim);margin-bottom:8px;}
.abar .abtns{display:flex;gap:6px;flex-wrap:wrap;}

/* Token actions row */
.tactions{display:flex;gap:6px;padding:0 20px;margin-bottom:10px;overflow-x:auto;}
.ta{
  background:var(--s1);border:1px solid var(--brd);border-radius:12px;
  padding:10px 14px;cursor:pointer;display:flex;align-items:center;gap:6px;
  font-size:.78rem;color:var(--dim);font-weight:600;flex-shrink:0;
  transition:all .15s;
}
.ta:active:not(:disabled){transform:scale(.95);}
.ta:disabled{opacity:.25;cursor:default;}
.ta .tc{font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--gold);}

/* Input fields */
.ginp{
  background:var(--s2);border:2px solid var(--brd);border-radius:12px;
  padding:12px 16px;color:var(--txt);font-family:'DM Sans',sans-serif;font-size:.92rem;
  outline:none;width:100%;transition:border-color .15s;
}
.ginp:focus{border-color:var(--acc);}
.ginp-yr{font-family:'JetBrains Mono',monospace;font-size:1.6rem;font-weight:700;color:var(--gold);text-align:center;width:140px;}
.gpanel{
  background:var(--s1);border:1px solid var(--brd);border-radius:16px;
  padding:18px;text-align:center;
}
.gpanel .gl{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;color:var(--dim);margin-bottom:8px;}
.grow{display:flex;gap:8px;justify-content:center;align-items:center;margin-bottom:8px;flex-wrap:wrap;}

/* HITSTER call */
.hpanel{
  background:linear-gradient(135deg,rgba(255,61,90,.06),rgba(255,215,0,.04));
  border:2px solid var(--acc);border-radius:16px;
  padding:18px;text-align:center;animation:up .25s ease;
}
.hpanel .ht{font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:2px;color:var(--acc);}
.hpanel .hs{font-size:.78rem;color:var(--dim);margin:4px 0 12px;}

/* ‚îÄ‚îÄ‚îÄ Overlay ‚îÄ‚îÄ‚îÄ */
.ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:100;align-items:flex-end;justify-content:center;}
.ov.show{display:flex;}
.ocard{
  background:var(--s1);border:1px solid var(--brd);border-radius:24px 24px 0 0;
  padding:32px 24px;padding-bottom:max(28px,var(--safe-b));
  text-align:center;width:100%;max-width:480px;
  animation:slideUp .4s cubic-bezier(.22,1,.36,1);
}
.ocard .oi{font-size:3rem;margin-bottom:10px;}
.ocard .ot{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;letter-spacing:2px;}
.ocard .od{color:var(--dim);font-size:.85rem;margin:6px 0 16px;line-height:1.4;}
.osong{background:var(--s2);border-radius:12px;padding:12px;margin-bottom:16px;}
.osong .st{font-weight:700;font-size:1rem;}
.osong .sa{color:var(--dim);font-size:.82rem;}
.osong .sy{font-family:'JetBrains Mono',monospace;font-size:1.2rem;font-weight:700;color:var(--gold);margin-top:4px;}
.otokens{color:var(--gold);font-family:'JetBrains Mono',monospace;font-size:.78rem;margin-bottom:10px;}

/* ‚îÄ‚îÄ‚îÄ End screen ‚îÄ‚îÄ‚îÄ */
.wdisplay{text-align:center;padding:32px 0;}
.wdisplay .crown{font-size:3rem;margin-bottom:10px;}
.wdisplay h2{font-family:'Bebas Neue',sans-serif;font-size:2.4rem;letter-spacing:3px;background:linear-gradient(135deg,var(--gold),#ff8a65);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.frow{
  display:flex;align-items:center;justify-content:space-between;
  padding:11px 16px;background:var(--s1);border:1px solid var(--brd);border-radius:12px;margin-bottom:6px;
}
.frow.w{border-color:var(--gold);background:rgba(255,215,0,.03);}
.frow .fr{font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--dim);width:24px;font-size:.85rem;}
.frow .fn{font-weight:700;flex:1;margin-left:8px;font-size:.9rem;}
.frow .fc{font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--gold);font-size:1rem;}

/* ‚îÄ‚îÄ‚îÄ iOS Install Banner ‚îÄ‚îÄ‚îÄ */
.ibanner{
  background:var(--s2);border:1px solid var(--brd);border-radius:14px;
  padding:14px 16px;margin:0 20px 12px;display:flex;align-items:center;gap:12px;
  font-size:.78rem;color:var(--dim);line-height:1.4;
}
.ibanner .ib-icon{font-size:1.4rem;flex-shrink:0;}
.ibanner .ib-close{background:none;border:none;color:var(--dim);font-size:1rem;padding:4px;cursor:pointer;flex-shrink:0;}
.ibanner strong{color:var(--txt);}

/* Subtle noise */
body::after{
  content:'';position:fixed;inset:0;
  background:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence baseFrequency='.8' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.03'/%3E%3C/svg%3E");
  pointer-events:none;z-index:9998;
}
</style>
</head>
<body>
<div class="app">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETUP SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="setup" class="scr on">
  <div class="hdr safe-top">
    <h1>HITSTER</h1>
    <div class="sub">Place the song. Build your timeline.</div>
  </div>

  <div class="scr-body">
    <div id="install-banner"></div>

    <div class="card" style="animation-delay:.05s">
      <h2>GAME MODE</h2>
      <div class="modes" id="modes"></div>
    </div>

    <div class="card" style="animation-delay:.1s">
      <h2>THEME</h2>
      <div class="chips" id="themes"></div>
    </div>

    <div class="card" style="animation-delay:.15s" id="players-card">
      <h2>PLAYERS</h2>
      <div id="players"></div>
      <button class="btn btn-ghost" onclick="addPlayer()" style="margin-top:8px">+ Add Player</button>
    </div>
  </div>

  <div class="scr-foot">
    <button class="btn btn-main" onclick="startGame()">START GAME</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="game" class="scr">
  <div class="gtop safe-top">
    <div>
      <div class="gl" id="g-round"></div>
      <div class="gbadge" id="g-badge">ORIGINAL</div>
    </div>
    <div class="gp" id="g-player"></div>
  </div>

  <div id="g-scores-area"></div>

  <div class="scr-body" id="game-body">
    <div class="vcard" id="vcard">
      <div class="vdisc" id="vdisc"><div class="gr"></div></div>
      <div class="vstat" id="vstat">TAP TO PLAY</div>
      <div class="play-row">
        <button class="pbtn" id="pbtn" onclick="togglePlay()">
          <svg viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>
        </button>
        <button class="sp-btn" onclick="openSpotify()">
          <svg viewBox="0 0 24 24"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
          Open in Spotify
        </button>
      </div>
      <div class="rinfo" id="rinfo" style="display:none">
        <div class="rt" id="rt"></div>
        <div class="ra" id="ra"></div>
        <div class="ry" id="ry"></div>
      </div>
    </div>

    <!-- Token actions -->
    <div class="tactions" id="tactions"></div>

    <!-- Timeline -->
    <div class="tlabel" id="tl-label">YOUR TIMELINE</div>
    <div class="tlwrap"><div class="tl" id="tl"></div></div>

    <!-- Placement confirm -->
    <div class="apanel" id="place-panel" style="display:none">
      <div class="abar">
        <div class="at">CONFIRM PLACEMENT</div>
        <div class="abtns">
          <button class="btn btn-s btn-grn" onclick="confirmPlace()" style="flex:1">PLACE HERE</button>
          <button class="btn btn-s" onclick="cancelPlace()" style="flex:1">CANCEL</button>
        </div>
      </div>
    </div>

    <!-- Knowledge panel (Pro/Expert) -->
    <div class="apanel" id="know-panel" style="display:none">
      <div class="gpanel">
        <div class="gl" id="kp-label">NAME TITLE & ARTIST</div>
        <div class="grow">
          <input class="ginp" id="k-title" placeholder="Song title..." style="flex:1">
        </div>
        <div class="grow">
          <input class="ginp" id="k-artist" placeholder="Artist..." style="flex:1">
        </div>
        <div class="grow" id="kp-yr" style="display:none">
          <input class="ginp ginp-yr" id="k-year" type="number" inputmode="numeric" min="1920" max="2025" placeholder="Year">
        </div>
        <button class="btn btn-s btn-main" onclick="submitKnow()" style="width:100%;margin-top:4px">SUBMIT</button>
      </div>
    </div>

    <!-- Earn token (Original) -->
    <div class="apanel" id="earn-panel" style="display:none">
      <div class="gpanel" style="border-color:var(--gold)">
        <div class="gl" style="color:var(--gold)">EARN A TOKEN</div>
        <div style="font-size:.72rem;color:var(--dim);margin-bottom:8px">Name title & artist correctly</div>
        <div class="grow">
          <input class="ginp" id="et-title" placeholder="Song title..." style="flex:1">
        </div>
        <div class="grow">
          <input class="ginp" id="et-artist" placeholder="Artist..." style="flex:1">
        </div>
        <div class="abtns" style="margin-top:4px">
          <button class="btn btn-s btn-gold" onclick="submitEarn()" style="flex:1">CLAIM</button>
          <button class="btn btn-s" onclick="skipEarn()" style="flex:1">SKIP</button>
        </div>
      </div>
    </div>

    <!-- HITSTER call -->
    <div class="apanel" id="hitster-panel" style="display:none">
      <div class="hpanel">
        <div class="ht">HITSTER!</div>
        <div class="hs">Does another player want to challenge?</div>
        <div id="hitster-btns" style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center"></div>
        <button class="btn btn-s" onclick="noHitster()" style="margin-top:8px;width:100%">No challenge ‚Äî continue</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OVERLAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="ov" id="ov">
  <div class="ocard">
    <div class="oi" id="o-icon"></div>
    <div class="ot" id="o-title"></div>
    <div class="od" id="o-detail"></div>
    <div class="osong">
      <div class="st" id="os-t"></div>
      <div class="sa" id="os-a"></div>
      <div class="sy" id="os-y"></div>
    </div>
    <div class="otokens" id="o-tok"></div>
    <button class="btn btn-main" onclick="nextTurn()" id="o-next">NEXT TURN</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê END SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="end" class="scr">
  <div class="scr-body safe-top">
    <div class="wdisplay">
      <div class="crown" id="e-icon">üëë</div>
      <h2 id="e-title">WINNER</h2>
      <div class="sub" style="margin-top:6px" id="e-sub"></div>
    </div>
    <div id="e-scores" style="padding:0 4px"></div>
  </div>
  <div class="scr-foot">
    <button class="btn btn-main" onclick="resetGame()">PLAY AGAIN</button>
  </div>
</div>

</div><!-- /app -->

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SONG DB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const S={
pop:[{t:"Billie Jean",a:"Michael Jackson",y:1983},{t:"Like a Prayer",a:"Madonna",y:1989},{t:"Baby One More Time",a:"Britney Spears",y:1999},{t:"Rolling in the Deep",a:"Adele",y:2011},{t:"Shape of You",a:"Ed Sheeran",y:2017},{t:"Wannabe",a:"Spice Girls",y:1996},{t:"Bad Guy",a:"Billie Eilish",y:2019},{t:"Uptown Funk",a:"Bruno Mars",y:2014},{t:"Call Me Maybe",a:"Carly Rae Jepsen",y:2012},{t:"Blinding Lights",a:"The Weeknd",y:2020},{t:"Toxic",a:"Britney Spears",y:2004},{t:"Hips Don't Lie",a:"Shakira",y:2006},{t:"Poker Face",a:"Lady Gaga",y:2008},{t:"Take On Me",a:"a-ha",y:1985},{t:"Girls Just Want to Have Fun",a:"Cyndi Lauper",y:1983},{t:"I Wanna Dance with Somebody",a:"Whitney Houston",y:1987},{t:"Vogue",a:"Madonna",y:1990},{t:"MMMBop",a:"Hanson",y:1997},{t:"Since U Been Gone",a:"Kelly Clarkson",y:2004},{t:"Umbrella",a:"Rihanna",y:2007},{t:"Happy",a:"Pharrell Williams",y:2013},{t:"Levitating",a:"Dua Lipa",y:2020},{t:"Shake It Off",a:"Taylor Swift",y:2014},{t:"Don't Start Now",a:"Dua Lipa",y:2019},{t:"Watermelon Sugar",a:"Harry Styles",y:2020}],
rock:[{t:"Bohemian Rhapsody",a:"Queen",y:1975},{t:"Stairway to Heaven",a:"Led Zeppelin",y:1971},{t:"Hotel California",a:"Eagles",y:1977},{t:"Smells Like Teen Spirit",a:"Nirvana",y:1991},{t:"Back in Black",a:"AC/DC",y:1980},{t:"Sweet Child O' Mine",a:"Guns N' Roses",y:1988},{t:"Creep",a:"Radiohead",y:1993},{t:"Wonderwall",a:"Oasis",y:1995},{t:"Mr. Brightside",a:"The Killers",y:2004},{t:"Seven Nation Army",a:"The White Stripes",y:2003},{t:"Paranoid",a:"Black Sabbath",y:1970},{t:"Born to Run",a:"Bruce Springsteen",y:1975},{t:"Roxanne",a:"The Police",y:1978},{t:"Every Breath You Take",a:"The Police",y:1983},{t:"Under the Bridge",a:"Red Hot Chili Peppers",y:1992},{t:"Basket Case",a:"Green Day",y:1994},{t:"Chop Suey!",a:"System of a Down",y:2001},{t:"The Pretender",a:"Foo Fighters",y:2007},{t:"Radioactive",a:"Imagine Dragons",y:2012},{t:"Thunder",a:"Imagine Dragons",y:2017},{t:"Satisfaction",a:"The Rolling Stones",y:1965},{t:"Light My Fire",a:"The Doors",y:1967},{t:"Smoke on the Water",a:"Deep Purple",y:1972},{t:"You Shook Me All Night Long",a:"AC/DC",y:1980},{t:"Livin' on a Prayer",a:"Bon Jovi",y:1986}],
hiphop:[{t:"Rapper's Delight",a:"The Sugarhill Gang",y:1979},{t:"Fight the Power",a:"Public Enemy",y:1989},{t:"Nuthin' but a 'G' Thang",a:"Dr. Dre",y:1992},{t:"Juicy",a:"The Notorious B.I.G.",y:1994},{t:"California Love",a:"2Pac",y:1996},{t:"Lose Yourself",a:"Eminem",y:2002},{t:"In Da Club",a:"50 Cent",y:2003},{t:"Gold Digger",a:"Kanye West",y:2005},{t:"Stronger",a:"Kanye West",y:2007},{t:"Hotline Bling",a:"Drake",y:2015},{t:"HUMBLE.",a:"Kendrick Lamar",y:2017},{t:"Sicko Mode",a:"Travis Scott",y:2018},{t:"Old Town Road",a:"Lil Nas X",y:2019},{t:"WAP",a:"Cardi B",y:2020},{t:"Ms. Jackson",a:"Outkast",y:2000},{t:"Hey Ya!",a:"Outkast",y:2003},{t:"Crazy in Love",a:"Beyonc√©",y:2003},{t:"Empire State of Mind",a:"Jay-Z",y:2009},{t:"Swimming Pools",a:"Kendrick Lamar",y:2012},{t:"Bodak Yellow",a:"Cardi B",y:2017},{t:"God's Plan",a:"Drake",y:2018},{t:"The Message",a:"Grandmaster Flash",y:1982},{t:"C.R.E.A.M.",a:"Wu-Tang Clan",y:1994},{t:"Stan",a:"Eminem",y:2000},{t:"Alright",a:"Kendrick Lamar",y:2015}],
electronic:[{t:"Blue Monday",a:"New Order",y:1983},{t:"Enjoy the Silence",a:"Depeche Mode",y:1990},{t:"Born Slippy",a:"Underworld",y:1996},{t:"Around the World",a:"Daft Punk",y:1997},{t:"Sandstorm",a:"Darude",y:1999},{t:"One More Time",a:"Daft Punk",y:2000},{t:"Harder Better Faster Stronger",a:"Daft Punk",y:2001},{t:"Scary Monsters and Nice Sprites",a:"Skrillex",y:2010},{t:"Levels",a:"Avicii",y:2011},{t:"Titanium",a:"David Guetta ft. Sia",y:2011},{t:"Get Lucky",a:"Daft Punk",y:2013},{t:"Lean On",a:"Major Lazer",y:2015},{t:"Faded",a:"Alan Walker",y:2015},{t:"Closure",a:"Bicep",y:2017},{t:"Cola",a:"CamelPhat",y:2017},{t:"Personal Jesus",a:"Depeche Mode",y:1989},{t:"Insomnia",a:"Faithless",y:1995},{t:"Children",a:"Robert Miles",y:1995},{t:"Better Off Alone",a:"Alice Deejay",y:1998},{t:"Strobe",a:"Deadmau5",y:2009},{t:"Midnight City",a:"M83",y:2011},{t:"Rather Be",a:"Clean Bandit",y:2014},{t:"Don't You Worry Child",a:"Swedish House Mafia",y:2012},{t:"Something About Us",a:"Daft Punk",y:2003},{t:"Calabria 2007",a:"Enur",y:2007}],
"80s":[{t:"Sweet Dreams",a:"Eurythmics",y:1983},{t:"Take On Me",a:"a-ha",y:1985},{t:"Don't Stop Believin'",a:"Journey",y:1981},{t:"Every Breath You Take",a:"The Police",y:1983},{t:"Blue Monday",a:"New Order",y:1983},{t:"Like a Virgin",a:"Madonna",y:1984},{t:"Jump",a:"Van Halen",y:1984},{t:"When Doves Cry",a:"Prince",y:1984},{t:"Everybody Wants to Rule the World",a:"Tears for Fears",y:1985},{t:"Money for Nothing",a:"Dire Straits",y:1985},{t:"West End Girls",a:"Pet Shop Boys",y:1985},{t:"Walk Like an Egyptian",a:"The Bangles",y:1986},{t:"With or Without You",a:"U2",y:1987},{t:"Need You Tonight",a:"INXS",y:1987},{t:"Don't Worry Be Happy",a:"Bobby McFerrin",y:1988},{t:"Love Shack",a:"The B-52's",y:1989},{t:"Pump Up the Jam",a:"Technotronic",y:1989},{t:"Under Pressure",a:"Queen & David Bowie",y:1981},{t:"Africa",a:"Toto",y:1982},{t:"Billie Jean",a:"Michael Jackson",y:1983},{t:"I Wanna Dance with Somebody",a:"Whitney Houston",y:1987},{t:"Sweet Child O' Mine",a:"Guns N' Roses",y:1988},{t:"Like a Prayer",a:"Madonna",y:1989},{t:"Livin' on a Prayer",a:"Bon Jovi",y:1986},{t:"Personal Jesus",a:"Depeche Mode",y:1989}],
"90s":[{t:"Smells Like Teen Spirit",a:"Nirvana",y:1991},{t:"Creep",a:"Radiohead",y:1993},{t:"Wonderwall",a:"Oasis",y:1995},{t:"No Diggity",a:"Blackstreet",y:1996},{t:"Wannabe",a:"Spice Girls",y:1996},{t:"MMMBop",a:"Hanson",y:1997},{t:"Bitter Sweet Symphony",a:"The Verve",y:1997},{t:"...Baby One More Time",a:"Britney Spears",y:1999},{t:"Waterfalls",a:"TLC",y:1995},{t:"No Scrubs",a:"TLC",y:1999},{t:"Jump Around",a:"House of Pain",y:1992},{t:"Enter Sandman",a:"Metallica",y:1991},{t:"Losing My Religion",a:"R.E.M.",y:1991},{t:"Under the Bridge",a:"Red Hot Chili Peppers",y:1992},{t:"Basket Case",a:"Green Day",y:1994},{t:"Juicy",a:"The Notorious B.I.G.",y:1994},{t:"California Love",a:"2Pac",y:1996},{t:"Karma Police",a:"Radiohead",y:1997},{t:"Around the World",a:"Daft Punk",y:1997},{t:"Ray of Light",a:"Madonna",y:1998},{t:"Believe",a:"Cher",y:1998},{t:"Iris",a:"Goo Goo Dolls",y:1998},{t:"Smooth",a:"Santana ft. Rob Thomas",y:1999},{t:"Born Slippy",a:"Underworld",y:1996},{t:"Nuthin' but a 'G' Thang",a:"Dr. Dre",y:1992}],
"2000s":[{t:"Crazy in Love",a:"Beyonc√©",y:2003},{t:"Hey Ya!",a:"Outkast",y:2003},{t:"In Da Club",a:"50 Cent",y:2003},{t:"Mr. Brightside",a:"The Killers",y:2004},{t:"Since U Been Gone",a:"Kelly Clarkson",y:2004},{t:"Gold Digger",a:"Kanye West",y:2005},{t:"Hips Don't Lie",a:"Shakira",y:2006},{t:"Rehab",a:"Amy Winehouse",y:2006},{t:"Umbrella",a:"Rihanna",y:2007},{t:"Stronger",a:"Kanye West",y:2007},{t:"Poker Face",a:"Lady Gaga",y:2008},{t:"Single Ladies",a:"Beyonc√©",y:2008},{t:"Viva la Vida",a:"Coldplay",y:2008},{t:"Empire State of Mind",a:"Jay-Z",y:2009},{t:"Toxic",a:"Britney Spears",y:2004},{t:"Seven Nation Army",a:"The White Stripes",y:2003},{t:"Lose Yourself",a:"Eminem",y:2002},{t:"Complicated",a:"Avril Lavigne",y:2002},{t:"Chop Suey!",a:"System of a Down",y:2001},{t:"One More Time",a:"Daft Punk",y:2000},{t:"Yellow",a:"Coldplay",y:2000},{t:"Stan",a:"Eminem",y:2000},{t:"Ms. Jackson",a:"Outkast",y:2000},{t:"Beautiful Day",a:"U2",y:2000},{t:"I Gotta Feeling",a:"Black Eyed Peas",y:2009}],
"2010s":[{t:"Rolling in the Deep",a:"Adele",y:2011},{t:"Somebody That I Used to Know",a:"Gotye",y:2011},{t:"Call Me Maybe",a:"Carly Rae Jepsen",y:2012},{t:"Gangnam Style",a:"PSY",y:2012},{t:"Royals",a:"Lorde",y:2013},{t:"Get Lucky",a:"Daft Punk",y:2013},{t:"Happy",a:"Pharrell Williams",y:2013},{t:"Shake It Off",a:"Taylor Swift",y:2014},{t:"Uptown Funk",a:"Bruno Mars",y:2014},{t:"Hotline Bling",a:"Drake",y:2015},{t:"Hello",a:"Adele",y:2015},{t:"Lean On",a:"Major Lazer",y:2015},{t:"Sorry",a:"Justin Bieber",y:2015},{t:"Closer",a:"The Chainsmokers",y:2016},{t:"Shape of You",a:"Ed Sheeran",y:2017},{t:"HUMBLE.",a:"Kendrick Lamar",y:2017},{t:"Despacito",a:"Luis Fonsi",y:2017},{t:"Sicko Mode",a:"Travis Scott",y:2018},{t:"Bad Guy",a:"Billie Eilish",y:2019},{t:"Old Town Road",a:"Lil Nas X",y:2019},{t:"Don't Start Now",a:"Dua Lipa",y:2019},{t:"Radioactive",a:"Imagine Dragons",y:2012},{t:"Swimming Pools",a:"Kendrick Lamar",y:2012},{t:"Bodak Yellow",a:"Cardi B",y:2017},{t:"God's Plan",a:"Drake",y:2018}],
classic:[{t:"Johnny B. Goode",a:"Chuck Berry",y:1958},{t:"Respect",a:"Aretha Franklin",y:1967},{t:"Light My Fire",a:"The Doors",y:1967},{t:"Satisfaction",a:"The Rolling Stones",y:1965},{t:"A Hard Day's Night",a:"The Beatles",y:1964},{t:"Good Vibrations",a:"The Beach Boys",y:1966},{t:"Hey Jude",a:"The Beatles",y:1968},{t:"Fortunate Son",a:"Creedence Clearwater Revival",y:1969},{t:"Imagine",a:"John Lennon",y:1971},{t:"Stairway to Heaven",a:"Led Zeppelin",y:1971},{t:"Superstition",a:"Stevie Wonder",y:1972},{t:"Smoke on the Water",a:"Deep Purple",y:1972},{t:"Bohemian Rhapsody",a:"Queen",y:1975},{t:"Hotel California",a:"Eagles",y:1977},{t:"Stayin' Alive",a:"Bee Gees",y:1977},{t:"Paranoid",a:"Black Sabbath",y:1970},{t:"Born to Run",a:"Bruce Springsteen",y:1975},{t:"Roxanne",a:"The Police",y:1978},{t:"Don't Stop Me Now",a:"Queen",y:1979},{t:"Rapper's Delight",a:"The Sugarhill Gang",y:1979},{t:"Let It Be",a:"The Beatles",y:1970},{t:"I Will Survive",a:"Gloria Gaynor",y:1978},{t:"We Will Rock You",a:"Queen",y:1977},{t:"Dancing Queen",a:"ABBA",y:1976},{t:"Blitzkrieg Bop",a:"Ramones",y:1976}],
dutch:[{t:"Radar Love",a:"Golden Earring",y:1973},{t:"Hocus Pocus",a:"Focus",y:1971},{t:"Venus",a:"Shocking Blue",y:1969},{t:"The Launch",a:"DJ Jean",y:1999},{t:"Adagio for Strings",a:"Ti√´sto",y:2005},{t:"Levels",a:"Avicii",y:2011},{t:"Calm After the Storm",a:"The Common Linnets",y:2014},{t:"Arcade",a:"Duncan Laurence",y:2019},{t:"Shotgun",a:"George Ezra",y:2018},{t:"Tsunami",a:"DVBBS & Borgeous",y:2013},{t:"Animals",a:"Martin Garrix",y:2013},{t:"Don't You Worry Child",a:"Swedish House Mafia",y:2012},{t:"Kernkraft 400",a:"Zombie Nation",y:1999},{t:"Better Off Alone",a:"Alice Deejay",y:1998},{t:"Sandstorm",a:"Darude",y:1999},{t:"Twilight Zone",a:"Golden Earring",y:1982},{t:"No Limit",a:"2 Unlimited",y:1993},{t:"Get Ready for This",a:"2 Unlimited",y:1991},{t:"Insomnia",a:"Faithless",y:1995},{t:"Calabria 2007",a:"Enur",y:2007},{t:"Cola",a:"CamelPhat",y:2017},{t:"Turn Up the Bass",a:"Tyree Cooper",y:1989},{t:"Somebody That I Used to Know",a:"Gotye",y:2011},{t:"Destination Calabria",a:"Alex Gaudino",y:2006},{t:"Bam Bam",a:"Camila Cabello",y:2022}]
};

const TH=[
  {id:"pop",e:"üé§",l:"Pop"},{id:"rock",e:"üé∏",l:"Rock"},{id:"hiphop",e:"üéß",l:"Hip-Hop"},
  {id:"electronic",e:"üéõÔ∏è",l:"Electronic"},{id:"classic",e:"üéµ",l:"Classics"},{id:"80s",e:"üìº",l:"80s"},
  {id:"90s",e:"üíø",l:"90s"},{id:"2000s",e:"üì±",l:"2000s"},{id:"2010s",e:"üî•",l:"2010s"},
  {id:"dutch",e:"üá≥üá±",l:"Dutch"}
];
const MD=[
  {id:"original",i:"üé∂",t:"ORIGINAL",d:"Place card. Earn tokens naming title & artist.",tk:2},
  {id:"pro",i:"üé§",t:"PRO",d:"Place + name title & artist to keep card.",tk:5},
  {id:"expert",i:"üèÜ",t:"EXPERT",d:"Place + title + artist + exact year.",tk:3},
  {id:"coop",i:"ü§ù",t:"CO-OP",d:"One team. 10 cards before tokens run out.",tk:5}
];
const COL=['#ff3d5a','#34d399','#60a5fa','#ffd700','#e040fb','#ff6e40'];
const WIN=10,MAXT=5;

let G={
  mode:'original',themes:['pop'],
  players:[{n:'Player 1',c:COL[0],tk:2,tl:[]}],
  pool:[],cur:null,pi:0,playing:false,
  phase:'listen',slot:null,
  ctk:5,ctl:[]
};

// ‚ïê‚ïê‚ïê HAPTICS ‚ïê‚ïê‚ïê
function haptic(style='light'){
  if(navigator.vibrate) navigator.vibrate(style==='heavy'?[30]:style==='medium'?[15]:[8]);
}

// ‚ïê‚ïê‚ïê SPOTIFY DEEP LINK ‚ïê‚ïê‚ïê
function openSpotify(){
  if(!G.cur)return;
  haptic('medium');
  const q=encodeURIComponent(`${G.cur.t} ${G.cur.a}`);
  // Try Spotify app URI first, falls back to web
  const spotifyUri=`spotify:search:${q}`;
  const webUrl=`https://open.spotify.com/search/${q}`;

  // On iOS, try the URI scheme which opens the app directly
  const start=Date.now();
  window.location.href=spotifyUri;

  // If app didn't open after 1.5s, fallback to web
  setTimeout(()=>{
    if(Date.now()-start<2000) window.open(webUrl,'_blank');
  },1500);
}

// ‚ïê‚ïê‚ïê SETUP ‚ïê‚ïê‚ïê
function init(){
  renderModes();renderThemes();renderPlayers();showInstallBanner();
  // Register SW
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }
}

function showInstallBanner(){
  // Show only on iOS Safari, not in standalone
  const ios=/iPad|iPhone|iPod/.test(navigator.userAgent);
  const standalone=window.navigator.standalone===true;
  if(ios&&!standalone){
    document.getElementById('install-banner').innerHTML=`
      <div class="ibanner">
        <span class="ib-icon">üì≤</span>
        <div>Add to Home Screen for the full app experience: tap <strong>Share</strong> then <strong>Add to Home Screen</strong></div>
        <button class="ib-close" onclick="this.parentElement.remove()">√ó</button>
      </div>`;
  }
}

function renderModes(){
  document.getElementById('modes').innerHTML=MD.map(m=>`
    <div class="mcard ${G.mode===m.id?'sel':''}" onclick="haptic();G.mode='${m.id}';renderModes();document.getElementById('players-card').style.display=G.mode==='coop'?'none':'block'">
      <div class="mi">${m.i}</div><div class="mt">${m.t}</div>
      <div class="md">${m.d}</div><div class="mk">${m.tk} tokens</div>
    </div>
  `).join('');
  document.getElementById('players-card').style.display=G.mode==='coop'?'none':'block';
}

function renderThemes(){
  document.getElementById('themes').innerHTML=TH.map(t=>`
    <div class="chip ${G.themes.includes(t.id)?'sel':''}" onclick="haptic();togTh('${t.id}')">
      <span class="ce">${t.e}</span>${t.l}
    </div>
  `).join('');
}
function togTh(id){
  const i=G.themes.indexOf(id);
  if(i>-1){if(G.themes.length>1)G.themes.splice(i,1);}else G.themes.push(id);
  renderThemes();
}

function renderPlayers(){
  document.getElementById('players').innerHTML=G.players.map((p,i)=>`
    <div class="prow">
      <div class="pdot" style="background:${p.c}"></div>
      <input class="pinp" value="${p.n}" onchange="G.players[${i}].n=this.value">
      ${G.players.length>1?`<button class="prm" onclick="G.players.splice(${i},1);renderPlayers()">√ó</button>`:''}
    </div>
  `).join('');
}
function addPlayer(){
  if(G.players.length>=6)return;
  haptic();
  G.players.push({n:`Player ${G.players.length+1}`,c:COL[G.players.length%COL.length],tk:2,tl:[]});
  renderPlayers();
}

// ‚ïê‚ïê‚ïê START ‚ïê‚ïê‚ïê
function startGame(){
  haptic('heavy');
  let pool=[];
  G.themes.forEach(t=>{if(S[t])pool=pool.concat(S[t]);});
  const seen=new Set();
  pool=pool.filter(s=>{const k=s.t+'|'+s.a;if(seen.has(k))return false;seen.add(k);return true;});
  shuf(pool); G.pool=pool; G.pi=0;

  const md=MD.find(m=>m.id===G.mode);
  if(G.mode==='coop'){
    G.ctk=md.tk; G.ctl=[];
    if(G.pool.length)G.ctl.push(G.pool.pop());
  }else{
    G.players.forEach(p=>{p.tk=md.tk;p.tl=[];if(G.pool.length)p.tl.push(G.pool.pop());});
  }
  show('game');startTurn();
}

// ‚ïê‚ïê‚ïê TURN ‚ïê‚ïê‚ïê
function startTurn(){
  if(G.mode==='coop'){
    if(G.ctl.length>=WIN+1||G.ctk<=0||!G.pool.length){endGame();return;}
  }else{
    if(G.players.some(p=>p.tl.length>=WIN+1)||!G.pool.length){endGame();return;}
  }
  G.cur=G.pool.pop();G.phase='listen';G.playing=false;G.slot=null;
  updTop();updScores();resetV();hideP();renderTL();renderTA();
}

function updTop(){
  const tl=G.mode==='coop'?G.ctl:G.players[G.pi].tl;
  document.getElementById('g-round').textContent=`CARDS: ${tl.length} / ${WIN+1}`;
  document.getElementById('g-badge').textContent=G.mode.toUpperCase();
  const el=document.getElementById('g-player');
  if(G.mode==='coop') el.innerHTML='<span class="dot" style="background:var(--grn)"></span> TEAM';
  else{const p=G.players[G.pi];el.innerHTML=`<span class="dot" style="background:${p.c}"></span> ${p.n}`;}
}

function updScores(){
  const area=document.getElementById('g-scores-area');
  if(G.mode==='coop'){
    area.innerHTML=`<div class="coop-bar">
      <div><div class="cl">TIMELINE</div><div class="cv">${G.ctl.length}/${WIN+1}</div></div>
      <div><div class="cl">TOKENS</div><div class="cv" style="color:var(--gold)">${'‚¨§ '.repeat(G.ctk)}</div></div>
    </div>`;
  }else{
    area.innerHTML='<div class="scores">'+G.players.map((p,i)=>{
      let toks='';
      for(let j=0;j<MAXT;j++) toks+=`<span class="tok ${j<p.tk?'':'empty'}"></span>`;
      return `<div class="spill ${i===G.pi?'on':''}">
        <span class="dot" style="background:${p.c}"></span>
        <span class="sn">${p.n}</span>
        <span class="sc">${p.tl.length}</span>
        <span class="st">${toks}</span>
      </div>`;
    }).join('')+'</div>';
  }
}

function renderTA(){
  const el=document.getElementById('tactions');
  const tk=G.mode==='coop'?G.ctk:G.players[G.pi].tk;
  el.innerHTML=`
    <div class="ta" onclick="skip()" ${tk<1?'disabled':''}>‚è≠ Skip <span class="tc">1 tok</span></div>
    <div class="ta" onclick="buy()" ${tk<3?'disabled':''}>üõí Buy <span class="tc">3 tok</span></div>
  `;
}

function skip(){
  haptic();
  if(G.mode==='coop'){if(G.ctk<1)return;G.ctk--;}
  else{const p=G.players[G.pi];if(p.tk<1)return;p.tk--;}
  stopM();
  if(!G.pool.length){endGame();return;}
  G.cur=G.pool.pop();G.playing=false;G.slot=null;
  resetV();hideP();updScores();renderTL();renderTA();
}

function buy(){
  haptic('medium');
  if(G.mode==='coop'){if(G.ctk<3)return;G.ctk-=3;if(G.pool.length){G.ctl.push(G.pool.pop());G.ctl.sort((a,b)=>a.y-b.y);}}
  else{const p=G.players[G.pi];if(p.tk<3)return;p.tk-=3;if(G.pool.length){p.tl.push(G.pool.pop());p.tl.sort((a,b)=>a.y-b.y);}}
  stopM();updScores();renderTL();renderTA();
  // Check win
  if(G.mode==='coop'){if(G.ctl.length>=WIN+1){endGame();return;}}
  else{if(G.players[G.pi].tl.length>=WIN+1){endGame();return;}}
  if(!G.pool.length){endGame();return;}
  G.cur=G.pool.pop();G.playing=false;G.slot=null;resetV();hideP();
}

// ‚ïê‚ïê‚ïê TIMELINE ‚ïê‚ïê‚ïê
function renderTL(){
  const tl=G.mode==='coop'?G.ctl:G.players[G.pi].tl;
  const el=document.getElementById('tl');
  document.getElementById('tl-label').textContent=G.mode==='coop'?'TEAM TIMELINE':G.players[G.pi].n.toUpperCase()+"'S TIMELINE";
  if(!tl.length){el.innerHTML='<div style="color:var(--dim);font-family:JetBrains Mono,monospace;font-size:.72rem;padding:12px">Empty</div>';return;}
  const sorted=[...tl].sort((a,b)=>a.y-b.y);
  let h=sl(0);
  sorted.forEach((s,i)=>{h+=`<div class="tlc"><div class="ty">${s.y}</div><div class="tn" title="${s.t}">${s.t}</div></div>`+sl(i+1);});
  el.innerHTML=h;
}
function sl(i){return `<div class="tls ${G.slot===i?'sel':''}" onclick="haptic();selSlot(${i})">+</div>`;}
function selSlot(i){G.slot=i;renderTL();document.getElementById('place-panel').style.display='block';}
function cancelPlace(){G.slot=null;document.getElementById('place-panel').style.display='none';renderTL();}

function confirmPlace(){
  haptic('medium');
  document.getElementById('place-panel').style.display='none';
  const tl=G.mode==='coop'?G.ctl:G.players[G.pi].tl;
  const sorted=[...tl].sort((a,b)=>a.y-b.y);
  const yr=G.cur.y,s=G.slot;
  let ok=true;
  if(s>0&&yr<sorted[s-1].y)ok=false;
  if(s<sorted.length&&yr>sorted[s].y)ok=false;
  if(s>0&&yr===sorted[s-1].y)ok=true;
  if(s<sorted.length&&yr===sorted[s].y)ok=true;
  stopM();

  if(G.mode==='original') origResult(ok);
  else if(G.mode==='pro') proResult(ok);
  else if(G.mode==='expert') expResult(ok);
  else coopResult(ok);
}

function origResult(ok){
  reveal();
  if(ok){addTL(G.cur);showEarn();}
  else{if(G.players.length>1)showHitster();else result(false,'WRONG','Card removed.');}
}
function proResult(ok){
  reveal();
  if(ok){addTL(G.cur);showKnow('pro');}// temp add, remove if fails
  else{if(G.players.length>1)showHitster();else result(false,'WRONG','Card removed.');}
}
function expResult(ok){
  reveal();
  if(ok){addTL(G.cur);showKnow('expert');}
  else{if(G.players.length>1)showHitster();else result(false,'WRONG','Card removed.');}
}
function coopResult(ok){
  reveal();
  if(ok){addTL(G.cur);result(true,'CORRECT!',`${G.cur.t} added to timeline.`);}
  else{G.ctk=Math.max(0,G.ctk-1);result(false,'WRONG!',`Lost 1 token. ${G.ctk} left.`);}
}

// ‚ïê‚ïê‚ïê KNOWLEDGE ‚ïê‚ïê‚ïê
function showKnow(mode){
  hideP();document.getElementById('know-panel').style.display='block';
  document.getElementById('k-title').value='';document.getElementById('k-artist').value='';document.getElementById('k-year').value='';
  document.getElementById('kp-yr').style.display=mode==='expert'?'flex':'none';
  document.getElementById('kp-label').textContent=mode==='expert'?'TITLE + ARTIST + YEAR':'TITLE + ARTIST';
}
function submitKnow(){
  haptic();
  const t=document.getElementById('k-title').value.trim().toLowerCase();
  const a=document.getElementById('k-artist').value.trim().toLowerCase();
  const y=parseInt(document.getElementById('k-year').value);
  const tm=fuz(t,G.cur.t.toLowerCase()),am=fuz(a,G.cur.a.toLowerCase());
  const ym=G.mode==='expert'?y===G.cur.y:true;
  if(tm&&am&&ym){result(true,'CORRECT!','Card stays on your timeline!');}
  else{rmTL(G.cur);let w=[];if(!tm)w.push('title');if(!am)w.push('artist');if(!ym)w.push('year');result(false,'NOT QUITE',`Wrong ${w.join(' & ')}. Card removed.`);}
}

// ‚ïê‚ïê‚ïê EARN TOKEN ‚ïê‚ïê‚ïê
function showEarn(){
  hideP();const p=G.players[G.pi];
  if(p.tk>=MAXT){result(true,'CORRECT!','Card added!');return;}
  document.getElementById('earn-panel').style.display='block';
  document.getElementById('et-title').value='';document.getElementById('et-artist').value='';
}
function submitEarn(){
  haptic();
  const t=document.getElementById('et-title').value.trim().toLowerCase();
  const a=document.getElementById('et-artist').value.trim().toLowerCase();
  const p=G.players[G.pi];
  let msg='';
  if(fuz(t,G.cur.t.toLowerCase())&&fuz(a,G.cur.a.toLowerCase())){p.tk=Math.min(MAXT,p.tk+1);msg='+1 TOKEN';}
  result(true,'CORRECT!','Card added to timeline.',msg);
}
function skipEarn(){result(true,'CORRECT!','Card added to timeline.');}

// ‚ïê‚ïê‚ïê HITSTER ‚ïê‚ïê‚ïê
function showHitster(){
  hideP();document.getElementById('hitster-panel').style.display='block';
  document.getElementById('hitster-btns').innerHTML=G.players.filter((_,i)=>i!==G.pi).map(p=>{
    const ri=G.players.indexOf(p);
    return `<button class="btn btn-s" onclick="hitCall(${ri})" ${p.tk<1?'disabled':''}style="flex:1;min-width:100px">
      <span class="dot" style="background:${p.c}"></span> ${p.n}
    </button>`;
  }).join('');
}
function hitCall(ci){
  haptic('heavy');
  const ch=G.players[ci];if(ch.tk<1)return;ch.tk--;
  ch.tl.push(G.cur);ch.tl.sort((a,b)=>a.y-b.y);
  hideP();result(false,'STOLEN!',`${ch.n} called HITSTER!`);
}
function noHitster(){hideP();result(false,'WRONG','Card removed.');}

// ‚ïê‚ïê‚ïê RESULT ‚ïê‚ïê‚ïê
function result(ok,title,detail,tokMsg=''){
  haptic(ok?'medium':'heavy');
  document.getElementById('o-icon').textContent=ok?'‚úÖ':'‚ùå';
  document.getElementById('o-title').textContent=title;
  document.getElementById('o-detail').textContent=detail;
  document.getElementById('os-t').textContent=G.cur.t;
  document.getElementById('os-a').textContent=G.cur.a;
  document.getElementById('os-y').textContent=G.cur.y;
  document.getElementById('o-tok').textContent=tokMsg;
  let over=false;
  if(G.mode==='coop'){if(G.ctl.length>=WIN+1||G.ctk<=0)over=true;}
  else{if(G.players.some(p=>p.tl.length>=WIN+1))over=true;}
  if(!G.pool.length)over=true;
  document.getElementById('o-next').textContent=over?'SEE RESULTS':'NEXT TURN';
  document.getElementById('ov').classList.add('show');
}

function nextTurn(){
  document.getElementById('ov').classList.remove('show');hideP();
  if(G.mode==='coop'){if(G.ctl.length>=WIN+1||G.ctk<=0||!G.pool.length){endGame();return;}}
  else{if(G.players.some(p=>p.tl.length>=WIN+1)||!G.pool.length){endGame();return;}G.pi=(G.pi+1)%G.players.length;}
  startTurn();
}

// ‚ïê‚ïê‚ïê VINYL ‚ïê‚ïê‚ïê
function resetV(){
  document.getElementById('vdisc').classList.remove('spin');
  document.getElementById('vstat').textContent='TAP TO PLAY';
  document.getElementById('pbtn').innerHTML='<svg viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>';
  document.getElementById('rinfo').style.display='none';
}
function reveal(){
  document.getElementById('rinfo').style.display='block';
  document.getElementById('rt').textContent=G.cur.t;
  document.getElementById('ra').textContent=G.cur.a;
  document.getElementById('ry').textContent=G.cur.y;
}
function togglePlay(){
  haptic();G.playing=!G.playing;
  document.getElementById('vdisc').classList.toggle('spin',G.playing);
  document.getElementById('vstat').textContent=G.playing?'NOW PLAYING...':'PAUSED';
  document.getElementById('pbtn').innerHTML=G.playing?
    '<svg viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>':
    '<svg viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>';
}
function stopM(){G.playing=false;document.getElementById('vdisc').classList.remove('spin');}

// ‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê
function addTL(s){if(G.mode==='coop'){G.ctl.push(s);G.ctl.sort((a,b)=>a.y-b.y);}else{G.players[G.pi].tl.push(s);G.players[G.pi].tl.sort((a,b)=>a.y-b.y);}}
function rmTL(s){const tl=G.mode==='coop'?G.ctl:G.players[G.pi].tl;const i=tl.findIndex(x=>x.t===s.t&&x.a===s.a);if(i>-1)tl.splice(i,1);}
function fuz(a,b){if(!a)return false;const n=s=>s.replace(/[^a-z0-9\s]/g,'').trim();const x=n(a),y=n(b);if(x===y)return true;if(y.includes(x)&&x.length>3)return true;if(x.includes(y)&&y.length>3)return true;return lev(x,y)<=Math.floor(y.length*.3);}
function lev(a,b){const m=a.length,n=b.length,d=Array.from({length:m+1},()=>Array(n+1).fill(0));for(let i=0;i<=m;i++)d[i][0]=i;for(let j=0;j<=n;j++)d[0][j]=j;for(let i=1;i<=m;i++)for(let j=1;j<=n;j++)d[i][j]=Math.min(d[i-1][j]+1,d[i][j-1]+1,d[i-1][j-1]+(a[i-1]!==b[j-1]?1:0));return d[m][n];}
function shuf(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}
function show(id){document.querySelectorAll('.scr').forEach(s=>s.classList.remove('on'));document.getElementById(id).classList.add('on');}
function hideP(){['place-panel','know-panel','earn-panel','hitster-panel'].forEach(id=>document.getElementById(id).style.display='none');}

// ‚ïê‚ïê‚ïê END ‚ïê‚ïê‚ïê
function endGame(){
  show('end');
  if(G.mode==='coop'){
    const won=G.ctl.length>=WIN+1;
    document.getElementById('e-icon').textContent=won?'üéâ':'üíî';
    document.getElementById('e-title').textContent=won?'YOU WON!':'GAME OVER';
    document.getElementById('e-sub').textContent=`${G.ctl.length-1} cards placed`;
    document.getElementById('e-scores').innerHTML=`<div class="card" style="text-align:center">
      <div style="font-family:'JetBrains Mono',monospace;font-size:1.2rem;color:var(--gold)">${G.ctl.length-1} / ${WIN}</div>
      <div style="margin-top:8px;font-size:.75rem;color:var(--dim)">${G.ctl.map(s=>`${s.y}`).join(' ‚Üí ')}</div>
    </div>`;
  }else{
    const sorted=[...G.players].sort((a,b)=>b.tl.length-a.tl.length);
    document.getElementById('e-icon').textContent='üëë';
    document.getElementById('e-title').textContent=sorted[0].n.toUpperCase();
    document.getElementById('e-sub').textContent=`${sorted[0].tl.length-1} CARDS`;
    document.getElementById('e-scores').innerHTML=sorted.map((p,i)=>`
      <div class="frow ${i===0?'w':''}">
        <span class="fr">#${i+1}</span><span class="dot" style="background:${p.c}"></span>
        <span class="fn">${p.n}</span><span class="fc">${p.tl.length-1}</span>
      </div>`).join('');
  }
}

function resetGame(){haptic();show('setup');}

init();
</script>
</body>
</html>
